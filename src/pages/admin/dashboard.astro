---
import LayoutAdmin from '../../layouts/LayoutAdmin.astro';
import TotalDetails from '../../components/admin/TotalDetails.astro';
export const prerender = false;
import { supabase } from '../../lib/supabase';
import AddTeamButton from '../../components/admin/AddTeamButton.astro';
import TournamentStandings from '../../sections/TournamentStandings.astro';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/admin/signin');
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken?.value || '',
    access_token: accessToken?.value || '',
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/admin/signin');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/admin/signin');
}
---

<LayoutAdmin description="La plataforma del Administrador" title="Admin Dashboard">
  <div
    id="success-message"
    class="fixed top-4 right-4 bg-white border-l-4 border-green-500 text-gray-700 px-6 py-3 rounded-lg shadow-lg opacity-0 transform -translate-y-4 transition-all duration-300 ease-in-out z-50"
  >
    <div class="flex items-center">
      <svg
        class="w-6 h-6 text-green-500 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"
        ></path>
      </svg>
      <p class="text-center font-medium"></p>
    </div>
  </div>
   <AddTeamButton />
  <h1 class="text-2xl font-bold mb-4">Vista General del Torneo</h1>
   <TournamentStandings isAdminView={true} />
  <TotalDetails />
</LayoutAdmin>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const successMessage = localStorage.getItem('successMessage');
    if (successMessage) {
      const messageElement = document.getElementById('success-message');
      if (messageElement) {
        const pElement = messageElement.querySelector('p');
        if (pElement) {
          pElement.textContent = successMessage;
        }

        setTimeout(() => {
          messageElement.classList.remove('opacity-0', '-translate-y-4');
        }, 100);

        setTimeout(() => {
          messageElement.classList.add('opacity-0', '-translate-y-4');
          setTimeout(() => {
            localStorage.removeItem('successMessage');
          }, 300);
        }, 3000);
      }
    }
  });
</script>
