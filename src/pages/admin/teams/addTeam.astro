---
import LayoutAdmin from "../../../layouts/LayoutAdmin.astro";

---
<LayoutAdmin description="La plataforma del Administrador" title="Añadir Nuevo Equipo">
  <section class="max-w-4xl mt-14 lg:mt-28 p-6 mx-auto bg-white rounded-md shadow-md dark:bg-gray-800">
    <h2 class="text-lg font-semibold text-gray-700 capitalize dark:text-white">Datos de Equipo</h2>
    <h2>Añadir nuevo equipo</h2>
    <form id="add-team-form">
      <label for="name">Nombre del equipo:</label>
      <input type="text" name="name" placeholder="Nombre del equipo" required />
      <br />
      <label for="group_id">ID del grupo:</label>
      <input type="number" name="group_id" placeholder="ID del grupo" required />
      <br />
      <label for="year">Año:</label>
      <input type="number" name="year" placeholder="Año" required />
      <br />
      <button type="submit">Añadir equipo</button>
    </form>
  </section>
</LayoutAdmin>

<script type="module">
 const token = window.__ACCESS_TOKEN__;
if (!token) {
  alert("No se encontró el token de autenticación. Por favor, inicie sesión nuevamente.");
  window.location.href = "/admin/signin"; // Redirigir al inicio de sesión si no hay token
  throw new Error("Token no disponible");
}

  const form = document.getElementById("add-team-form");

  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const name = formData.get("name");
      const group_id = parseInt(formData.get("group_id"), 10);
      const year = parseInt(formData.get("year"), 10);

      if (!name || isNaN(group_id) || isNaN(year)) {
        alert("Por favor, rellene todos los campos correctamente.");
        return;
      }

      try {
        const response = await fetch("/api/add-team", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({ name, group_id, year }),
        });
        const result = await response.json();
        console.log("Respuesta del servidor: ", result);
        if (!response.ok) {
          throw new Error(result.message || "Error desconocido");
        }
        alert("Equipo añadido con éxito");
        form.reset();
      } catch (error) {
        console.error("Error al insertar equipo:", error);
        alert("Error: " + error.message);
      }
    });
  } else {
    console.error("Formulario no encontrado");
  }
</script>
