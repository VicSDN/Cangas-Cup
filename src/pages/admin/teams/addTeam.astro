---
import LayoutAdmin from '../../../layouts/LayoutAdmin.astro';
---

<LayoutAdmin description="La plataforma del Administrador" title="Añadir Nuevo Equipo">
  <section
    class="max-w-4xl mt-14 lg:mt-28 p-6 mx-auto bg-white rounded-md shadow-md dark:bg-gray-800"
  >
    <h2 class="text-lg font-semibold text-gray-700 capitalize dark:text-white">Datos de Equipo</h2>
    <h2>Añadir nuevo equipo</h2>
    <form id="add-team-form" class="space-y-4">
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
          >Nombre del equipo:</label
        >
        <input
          type="text"
          name="name"
          id="name"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          placeholder="Nombre del equipo"
          required
        />
      </div>
      <div>
        <label for="group_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
          >ID del grupo:</label
        >
        <input
          type="number"
          name="group_id"
          id="group_id"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          placeholder="ID del grupo"
          required
        />
      </div>
      <div>
        <label for="year" class="block text-sm font-medium text-gray-700 dark:text-gray-300"
          >Año:</label
        >
        <input
          type="number"
          name="year"
          id="year"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
          placeholder="Año"
          required
        />
      </div>
      <button
        type="submit"
        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        Añadir equipo
      </button>
    </form>
  </section>
</LayoutAdmin>

<script>
  const token = localStorage.getItem('sb-access-token');

  if (!token) {
    alert('No se encontró el token de autenticación. Por favor, inicie sesión nuevamente.');
    window.location.href = '/admin/signin';
    throw new Error('Token no disponible');
  }

  const form = document.getElementById('add-team-form') as HTMLFormElement;

  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const name = formData.get('name')?.toString().trim();
      const group_id = parseInt(formData.get('group_id')?.toString() || '0', 10);
      const year = parseInt(formData.get('year')?.toString() || '0', 10);

      if (!name || isNaN(group_id) || isNaN(year)) {
        alert('Por favor, rellene todos los campos correctamente.');
        return;
      }

      try {
        console.log('Enviando petición con token:', token);
        const response = await fetch('/api/add-team', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ name, group_id, year }),
        });

        const result = await response.json();
        console.log('Respuesta del servidor:', result);

        if (!response.ok) {
          throw new Error(result.message || 'Error al añadir el equipo');
        }
        window.location.href = '/admin/dashboard';
      } catch (error) {
        console.error('Error al insertar equipo:', error);
        alert(error instanceof Error ? error.message : 'Error al añadir el equipo');
      }
    });
  } else {
    console.error('Formulario no encontrado');
  }
</script>
